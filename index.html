<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wish Time</title>
  <style>
    body {
      margin: 0;
      background: #ccc;
      font-family: 'Courier New', monospace;
      color: rgb(0, 0, 255);
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #f5f5f5;
      box-shadow: 4px 4px 0px #999;
    }

    h1 {
      font-size: 1.5em;
      margin-bottom: 0.5em;
    }

    #clock {
      margin-bottom: 1em;
    }

    input[type="text"] {
      padding: 5px;
      font-family: monospace;
      width: 100%;
      margin-bottom: 10px;
    }

    button {
      padding: 8px 12px;
      font-family: monospace;
      background: white;
      border: 2px solid rgb(0, 0, 255);
      box-shadow: 2px 2px 0px #999;
      cursor: pointer;
    }

    #previewContainer, #gallery {
      margin-top: 20px;
    }

    .photo-frame {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: relative;
      display: inline-block;
    }

    .photo-frame img {
      max-width: 100%;
      display: block;
    }

    .stamp {
      position: relative;
      color: blue;
      font-family: Helvetica, Arial, sans-serif;
      font-weight: bold;
      font-size: 16px;
    }

    .stamp.username {
      bottom: 10px;
      left: 10px;
    }

    .stamp.time {
      bottom: 10px;
      right: 10px;
    }

    #photoInput {
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wish Time</h1>
    <div id="clock"></div>

    <div id="nameInputContainer">
      <input type="text" id="username" placeholder="Your Name (e.g. Moonkid)">
      <button onclick="saveName()">Start</button>
    </div>

    <div id="uploadSection" style="display:none;">
      <input type="file" accept="image/*" capture="environment" id="photoInput">
    </div>

    <div id="previewContainer"></div>
    <div id="gallerySection" style="display:none;">
      <h2>Your Wishes</h2>
      <div id="gallery"></div>
    </div>
  </div>

  <script>
    const usernameInput = document.getElementById('username');
    const nameInputContainer = document.getElementById('nameInputContainer');
    const uploadSection = document.getElementById('uploadSection');
    const photoInput = document.getElementById('photoInput');
    const previewContainer = document.getElementById('previewContainer');
    const gallery = document.getElementById('gallery');
    const gallerySection = document.getElementById('gallerySection');
    const clock = document.getElementById('clock');

    function updateClock() {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString('en-GB');
    }
    setInterval(updateClock, 1000);
    updateClock();

    function saveName() {
      const name = usernameInput.value.trim();
      if (name) {
        localStorage.setItem('wish_username', name);
        nameInputContainer.style.display = 'none';
        uploadSection.style.display = 'block';
      }
    }

    window.onload = () => {
      const savedName = localStorage.getItem('wish_username');
      if (savedName) {
        nameInputContainer.style.display = 'none';
        uploadSection.style.display = 'block';
      }
      loadGallery();
    };

    photoInput.addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      const img = new Image();
      const reader = new FileReader();
      reader.onload = async function(e) {
        img.onload = async () => {
          const canvas = document.createElement('canvas');
          const MAX_WIDTH = 800;
          const scale = MAX_WIDTH / img.width;
          canvas.width = MAX_WIDTH;
          canvas.height = img.height * scale;
          const ctx = canvas.getContext('2d');

          // Mirror image
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

          // Add text
          const name = localStorage.getItem('wish_username') || "Unknown";
          const now = new Date();
          const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });

          ctx.setTransform(1, 0, 0, 1, 0, 0); // reset transform
          ctx.font = 'bold 32px Helvetica, Arial';
          ctx.fillStyle = 'white';
          ctx.opacity = 0.5;
          ctx.globalAlpha = 0.85;
          ctx.textShadow = '1px 1px 2px black';
          ctx.fillText(name, 20, canvas.height - 20);
          ctx.fillText(time, canvas.width - 120, canvas.height - 20);
          ctx.globalAlpha = 1;

          const compressedDataUrl = canvas.toDataURL('image/jpeg', 0.8); // compress
          const entry = {
            src: compressedDataUrl,
            timestamp: now.getTime(),
            readable: now.toLocaleTimeString('en-GB'),
            name
          };

          let photos = JSON.parse(localStorage.getItem('wish_photos') || "[]");
          photos.push(entry);
          localStorage.setItem("wish_photos", JSON.stringify(photos));

          photoInput.value = '';
          previewContainer.innerHTML = '';
          loadGallery(true);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    });

    function loadGallery(justUploaded = false) {
      let photos = JSON.parse(localStorage.getItem("wish_photos") || "[]");
      const now = Date.now();
      photos = photos.filter(p => now - p.timestamp < 24 * 60 * 60 * 1000);
      localStorage.setItem("wish_photos", JSON.stringify(photos));

      if (justUploaded) {
        gallerySection.style.display = 'block';
        setTimeout(() => {
          gallerySection.style.display = 'none';
        }, 2 * 60 * 1000); // 2 minutes
      }

      gallery.innerHTML = "";
      photos.forEach(p => {
        const wrapper = document.createElement("div");
        wrapper.className = "photo-frame";

        const img = document.createElement("img");
        img.src = p.src;

        const usernameStamp = document.createElement("div");
        usernameStamp.className = "stamp username";
        usernameStamp.textContent = p.name;

        const timeStamp = document.createElement("div");
        timeStamp.className = "stamp time";
        timeStamp.textContent = p.readable;

        wrapper.appendChild(img);
        wrapper.appendChild(usernameStamp);
        wrapper.appendChild(timeStamp);
        gallery.appendChild(wrapper);
      });
    }
  </script>
</body>
</html>