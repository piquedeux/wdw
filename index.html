<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Wish Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      background: #dcdcdc;
      font-family: 'Courier New', monospace;
      color: #000;
      padding: 1rem;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 0.5em;
    }
    #clock {
      margin-bottom: 1em;
    }
    input, button {
      font-family: 'Courier New', monospace;
      padding: 0.5em;
      border: none;
      background: #fff;
      color: #000;
      margin: 0.25em 0;
      box-shadow: 2px 2px 0 #000;
    }
    #uploadSection {
      margin-top: 1em;
    }
    .gallery-item {
      margin-top: 1em;
      position: relative;
    }
    .gallery-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8em;
      letter-spacing: -0.5px;
      margin-top: 0.2em;
    }
    .preview {
      max-width: 100%;
      margin-top: 1em;
    }
    .hide {
      display: none;
    }
    .download-btn {
      margin-top: 0.25em;
      font-size: 0.8em;
    }
  </style>
</head>
<body>
  <h1>Wish Time</h1>
  <div id="clock"></div>

  <div id="nameInputContainer">
    <input type="text" id="username" placeholder="Enter your name" />
    <button onclick="saveName()">Start</button>
  </div>

  <div id="uploadSection" class="hide">
    <p id="uploadStatus">Waiting for a wish time like 10:10, 11:11…</p>
    <input type="file" accept="image/*" capture="environment" id="photoInput" onchange="handlePhoto(event)" />
    <img id="preview" class="preview hide" />
    <button id="removeBtn" class="hide" onclick="removePreview()">Remove</button>
  </div>

  <div id="gallerySection" class="hide">
    <h2>Your Wish Photos</h2>
    <div id="gallery"></div>
  </div>

  <script>
    const clock = document.getElementById("clock");
    const uploadSection = document.getElementById("uploadSection");
    const gallerySection = document.getElementById("gallerySection");
    const gallery = document.getElementById("gallery");
    const preview = document.getElementById("preview");
    const removeBtn = document.getElementById("removeBtn");
    const photoInput = document.getElementById("photoInput");

    let galleryVisibleUntil = 0;
    let currentPreview = null;

    function updateClock() {
      const now = new Date();
      clock.textContent = now.toLocaleTimeString();
      checkTimeAndShow();
    }
    setInterval(updateClock, 1000);

    function saveName() {
      const name = document.getElementById("username").value.trim();
      if (name) {
        localStorage.setItem("wish_name", name);
        document.getElementById("nameInputContainer").style.display = "none";
        checkTimeAndShow();
      }
    }

    function isWishTime() {
      const now = new Date();
      return now.getHours() === now.getMinutes(); // e.g. 10:10, 11:11
    }

    function checkTimeAndShow() {
      const name = localStorage.getItem("wish_name");
      if (!name) return;

      const statusText = document.getElementById("uploadStatus");
      const now = Date.now();

      uploadSection.classList.remove("hide");
      if (isWishTime()) {
        statusText.textContent = "It's Wish Time! Take a photo!";
      } else {
        statusText.textContent = "Waiting for a wish time like 10:10, 11:11…";
      }

      if (now < galleryVisibleUntil) {
        gallerySection.classList.remove("hide");
        showGallery();
      } else {
        gallerySection.classList.add("hide");
      }
    }

    function removePreview() {
      currentPreview = null;
      preview.src = "";
      preview.classList.add("hide");
      removeBtn.classList.add("hide");
    }

    function handlePhoto(event) {
      const file = event.target.files[0];
      if (!file) return;

      const name = localStorage.getItem("wish_name");
      const reader = new FileReader();
      reader.onload = function (e) {
        const img = new Image();
        img.onload = function () {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");

          // mirror image
          ctx.translate(canvas.width, 0);
          ctx.scale(-1, 1);
          ctx.drawImage(img, 0, 0);

          // reset transform to add non-mirrored text
          ctx.setTransform(1, 0, 0, 1, 0, 0);

          const time = new Date();
          const timestamp = time.toLocaleTimeString("en-GB", { hour: '2-digit', minute: '2-digit' });
          const fullTime = time.toLocaleTimeString("en-GB");

          ctx.font = "bold 32px Helvetica, Arial, sans-serif";
          ctx.fillStyle = "rgba(255,255,255,0.5)";
          ctx.textBaseline = "bottom";
          ctx.fillText(name, 20, canvas.height - 20);
          ctx.textAlign = "right";
          ctx.fillText(timestamp, canvas.width - 20, canvas.height - 20);

          const finalImage = canvas.toDataURL("image/jpeg", 0.8);
          preview.src = finalImage;
          preview.classList.remove("hide");
          removeBtn.classList.remove("hide");

          const photos = getPhotos();
          photos.push({ src: finalImage, name, time: fullTime, retake: photos.length > 0 });
          localStorage.setItem("wish_photos", JSON.stringify(photos));

          galleryVisibleUntil = Date.now() + 2 * 60 * 1000;
          showGallery();
          gallerySection.classList.remove("hide");
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);

      // reset input
      event.target.value = "";
    }

    function getPhotos() {
      const all = JSON.parse(localStorage.getItem("wish_photos") || "[]");
      const recent = all.filter(p => Date.now() - new Date(p.time).getTime() < 24 * 60 * 60 * 1000);
      localStorage.setItem("wish_photos", JSON.stringify(recent));
      return recent;
    }

    function showGallery() {
      const photos = getPhotos();
      gallery.innerHTML = "";
      photos.forEach(p => {
        const wrapper = document.createElement("div");
        wrapper.className = "gallery-item";

        const img = document.createElement("img");
        img.src = p.src;
        img.className = "preview";

        const meta = document.createElement("div");
        meta.className = "gallery-meta";
        meta.innerHTML = `<span>${p.name}${p.retake ? " (Retake)" : ""}</span><span>${p.time}</span>`;

        const dl = document.createElement("a");
        dl.href = p.src;
        dl.download = "wish-photo.jpg";
        dl.textContent = "Download";
        dl.className = "download-btn";

        wrapper.appendChild(img);
        wrapper.appendChild(meta);
        wrapper.appendChild(dl);
        gallery.appendChild(wrapper);
      });
    }

    window.onload = () => {
      const name = localStorage.getItem("wish_name");
      if (name) {
        document.getElementById("nameInputContainer").style.display = "none";
        checkTimeAndShow();
      }
    };
  </script>
</body>
</html>