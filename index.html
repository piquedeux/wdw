<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Wish Time</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #e0e0e0;
      color: #000;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 600px;
      margin: 20px auto;
      padding: 20px;
      background: #fff;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.2);
    }

    h1 {
      text-align: center;
      margin-top: 0;
    }

    #previewWrapper {
      background: #fff;
      border: 10px solid white;
      margin: 20px auto;
      width: 90%;
      max-width: 300px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.3);
      position: relative;
    }

    #previewCanvas {
      width: 100%;
    }

    .stamp {
      position: absolute;
      color: white;
      font-family: Helvetica, Arial, sans-serif;
      font-weight: bold;
      opacity: 0.5;
      font-size: 18px;
      letter-spacing: -1px;
      text-shadow: 1px 1px 2px black;
    }

    .stamp.time {
      bottom: 8px;
      right: 8px;
    }

    .stamp.user {
      bottom: 8px;
      left: 8px;
    }

    #gallery .entry {
      background: #fefefe;
      margin: 20px 0;
      padding: 10px;
      box-shadow: inset 0 0 3px rgba(0,0,0,0.1);
    }

    #gallery img {
      width: 100%;
      display: block;
    }

    .below-info {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 4px;
      color: #333;
    }

    #nameInput {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    input, button {
      padding: 8px;
      border: 1px solid #999;
      background: #cce;
      font-family: monospace;
      font-size: 14px;
    }

    #gallery {
      display: none;
    }

    @media (max-width: 480px) {
      .container {
        padding: 12px;
      }

      .stamp {
        font-size: 14px;
      }

      .below-info {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Wish Time</h1>
    <div id="nameInput">
      <input type="text" id="username" placeholder="Your name">
      <button onclick="start()">Start</button>
    </div>

    <input type="file" accept="image/*" capture="environment" id="photoInput" style="display:none" onchange="handlePhoto(event)">

    <div id="previewWrapper" style="display:none;">
      <canvas id="previewCanvas"></canvas>
    </div>

    <div id="gallery"></div>
  </div>

  <script>
    const photoInput = document.getElementById("photoInput");
    const previewCanvas = document.getElementById("previewCanvas");
    const ctx = previewCanvas.getContext("2d");
    const previewWrapper = document.getElementById("previewWrapper");
    const gallery = document.getElementById("gallery");

    let username = localStorage.getItem("wish_username");
    let allowGalleryUntil = 0;

    function start() {
      const nameInput = document.getElementById("username").value.trim();
      if (nameInput) {
        username = nameInput;
        localStorage.setItem("wish_username", username);
        document.getElementById("nameInput").style.display = "none";
        triggerPhoto();
      }
    }

    function triggerPhoto() {
      photoInput.click();
    }

    function handlePhoto(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        const img = new Image();
        img.onload = function() {
          const maxSize = 1024;
          let w = img.width;
          let h = img.height;
          if (w > maxSize || h > maxSize) {
            if (w > h) {
              h *= maxSize / w;
              w = maxSize;
            } else {
              w *= maxSize / h;
              h = maxSize;
            }
          }

          previewCanvas.width = w;
          previewCanvas.height = h;

          ctx.save();
          ctx.translate(w, 0);
          ctx.scale(-1, 1); // mirror horizontally
          ctx.drawImage(img, 0, 0, w, h);
          ctx.restore();

          const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
          ctx.fillStyle = "white";
          ctx.font = "bold 32px Helvetica, Arial";
          ctx.globalAlpha = 0.5;
          ctx.textAlign = "right";
          ctx.fillText(time, w - 16, h - 16);
          ctx.textAlign = "left";
          ctx.fillText(username, 16, h - 16);
          ctx.globalAlpha = 1.0;

          previewWrapper.style.display = "block";

          // Save compressed image
          previewCanvas.toBlob(blob => {
            const reader = new FileReader();
            reader.onloadend = () => {
              saveToGallery(reader.result, time);
            };
            reader.readAsDataURL(blob);
          }, 'image/jpeg', 0.8);
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function saveToGallery(dataUrl, time) {
      const now = Date.now();
      let photos = JSON.parse(localStorage.getItem("wish_photos") || "[]");

      photos.push({src: dataUrl, time, username, timestamp: now});
      localStorage.setItem("wish_photos", JSON.stringify(photos));

      allowGalleryUntil = now + 2 * 60 * 1000; // 2 minutes
      showGallery();
    }

    function showGallery() {
      const now = Date.now();
      let photos = JSON.parse(localStorage.getItem("wish_photos") || "[]");
      photos = photos.filter(p => now - p.timestamp < 24 * 60 * 60 * 1000);
      localStorage.setItem("wish_photos", JSON.stringify(photos));

      if (now > allowGalleryUntil) {
        gallery.style.display = "none";
        return;
      }

      gallery.innerHTML = "";
      photos.forEach((p, i) => {
        const entry = document.createElement("div");
        entry.className = "entry";

        const img = document.createElement("img");
        img.src = p.src;

        const below = document.createElement("div");
        below.className = "below-info";
        below.innerHTML = `
          <span>#${i + 1} today</span>
          <span>${p.time}</span>
        `;

        entry.appendChild(img);
        entry.appendChild(below);
        gallery.appendChild(entry);
      });

      gallery.style.display = "block";
    }

    window.onload = () => {
      if (username) {
        document.getElementById("nameInput").style.display = "none";
        triggerPhoto();
      }
    };

    setInterval(showGallery, 5000); // auto-hide gallery after 2 minutes
  </script>
</body>
</html>